# 実装計画

- [x] 1. レイヤー基盤を整備する
- [x] 1.1 (P) レイヤーディレクトリとパスエイリアスを確定する
  - `src`配下にドメイン、アプリケーション、インフラ、プレゼンテーションの境界を新設し、既存のApp RouterとUIコンポーネント領域をプレゼンテーションとして明示する
  - 各レイヤーのサブディレクトリ構成を合意し、依存方向を示すパスエイリアスをTypeScript設定に反映する
  - 新構成で型チェックとビルドが通ることを短いサンプルで確認し、逸脱時の検知方法を共有する
  - _Requirements: 1.1,1.2,1.3,1.4,1.5,1.7_

- [x] 1.2 (P) 既存資産のレイヤー配置計画を策定する
  - libやtypesの責務を洗い出し、ドメイン・アプリケーション・インフラへの移行先をマッピングする
  - 旧構成と新構成が一時共存する期間の参照ルールと移行順を決め、影響範囲を可視化する
  - インポート更新を自動化するスクリプトや手順を準備し、段階的移行で破綻しないようにする
  - _Requirements: 1.6,9.2,9.5_

- [x] 2. ドメイン層を純粋なビジネスロジックとして構築する
- [x] 2.1 (P) エンティティと値オブジェクトを定義する
  - Member・Event・Timetableの状態とふるまいを不変モデルで表現し、学年計算や定員チェックなどのビジネスルールを内包させる
  - Email・StudentId・EventCapacityの値オブジェクトを実装し、生成時にバリデーションを行う
  - 複数エンティティに跨るロジックをドメインサービスに集約し、外部依存を持たない形にする
  - _Requirements: 2.1,2.2,2.3,2.4,2.5,2.7_

- [x] 2.2 (P) ドメインの独立性と不変条件を検証する
  - ドメイン層が外部ライブラリや他レイヤーへ依存していないことを静的に確認する
  - 生成・更新時に不正状態を拒否するガードを用意し、例外やエラー型の扱いを決める
  - 既存ビジネスロジックを移行しても振る舞いが変わらないことをサンプルで確認する
  - _Requirements: 2.6,2.7,6.1_

- [x] 3. アプリケーション層でユースケース駆動のAPIを構築する
- [x] 3.1 (P) ポートとDTO契約を定義する
  - リポジトリや認証サービスのポートを整理し、依存性逆転を前提としたインターフェース契約を用意する
  - サーバー・クライアント間でシリアライズ可能なDTOを設計し、日付やIDの取り扱いルールを決める
  - アプリケーション層がドメインのみを参照することを確認し、境界外参照を検知する仕組みを組み込む
  - _Requirements: 3.3,3.4,3.5,6.2_

- [x] 3.2 (P) クエリ系ユースケースを実装する
  - プロフィール取得や一覧取得のユースケースでexecuteエントリーポイントを整備し、Resultベースのエラーハンドリングを適用する
  - ドメインエンティティからDTOへの変換責務を明確にし、ビジネスルールの評価順序を固定する
  - 失敗時の例外種別と呼び出し側への伝播方法を揃え、再利用しやすいレスポンス形に整える
  - _Requirements: 3.1,3.2,3.6,3.7_

- [x] 3.3 (P) コマンド系ユースケースを実装する
  - 参加登録やプロフィール更新などの書き込みユースケースにトランザクション境界を設定する
  - ポート経由でインフラ層を呼び出し、重複登録や定員超過などのビジネスルールを実行前に検証する
  - 例外とアプリケーションエラーを分類し、呼び出し元がUIに伝えやすい形で返す
  - _Requirements: 3.1,3.2,3.6,3.8_

- [x] 4. インフラストラクチャで外部サービス統合を実現する
- [x] 4.1 (P) データアクセス基盤を整える
  - Supabaseクライアントの初期化手順と資格情報検証を整理し、RLSを前提とした接続パターンを固める
  - 接続失敗や認証エラー時の標準化されたエラー構造を用意し、上位層が扱えるようにする
  - _Requirements: 4.3,4.7_

- [x] 4.2 (P) リポジトリ実装とデータマッピングを行う
  - Member・Event・Timetable向けのリポジトリでCRUDと検索を実装し、ポート契約に沿ったResultを返す
  - データベースの型とドメインモデルを相互に変換するマッパーを用意し、欠損値や不正値の扱いを定義する
  - 外部API連携が必要な場合の拡張ポイントを決め、依存注入で切り替えられるようにする
  - _Requirements: 4.1,4.2,4.5,4.6,4.8_

- [x] 4.3 (P) 認証基盤と依存性注入を統合する
  - 認証プロバイダーをポート契約に沿って実装し、ロール判定やセッション取得の流れを統一する
  - DIコンテナにリポジトリとサービスを登録し、シングルトン管理やテスト用差し替えの方針を決める
  - _Requirements: 4.4,4.9,7.4_

- [x] 4.4 (P) トランザクション処理をRPCで実装する
  - 参加登録・解除の処理をデータベース側のRPCで原子的に実行し、定員チェックを含むビジネスルールを担保する
  - RPCの結果とエラーをアプリケーション層で扱えるフォーマットに正規化する
  - _Requirements: 3.8,4.1,4.2_

- [x] 5. プレゼンテーション層でユースケースとUIを接続する
- [x] 5.1 Server Actionsを実装しユースケースを橋渡しする
  - サーバーコンテキストでユースケースを解決し、DTOを返却する標準フローを整える
  - エラーをユーザー向けメッセージや再入力案内に変換する規約を決める
  - _Requirements: 5.5,5.7,5.9_

- [x] 5.2 ページとUIをClean Architectureに合わせて再構成する
  - 主要ページをサーバーコンポーネント基調にし、ユースケース経由でデータ取得・操作を行う流れに統一する
  - クライアントコンポーネントはインタラクションに専念させ、サーバー経由の呼び出し境界を明文化する
  - 既存のプロフィール、イベント、タイムテーブル、管理機能が同等の体験で動作し、UIライブラリのデザインを維持することを確認する
  - _Requirements: 5.1,5.2,5.3,5.4,5.6,5.8,7.1,7.2,7.3,7.5,7.6_

- [x] 5.3 エラー体験と通知を統一する
  - ユースケースからの失敗理由をUIで一貫した表示や再試行導線に落とし込み、想定外エラーを捕捉する仕組みを入れる
  - 入力検証エラーと権限エラーで異なる挙動（再入力・リダイレクト等）を定義し、ユーザーが迷わないようにする
  - _Requirements: 5.7,5.8_

- [x] 6. 依存性ルールと静的検証を整備する
- [x] 6.1 (P) レイヤー依存性チェックを自動化する
  - ドメイン→アプリケーション→インフラ→プレゼンテーションの依存方向を守るための静的解析ルールを設定する
  - プレゼンテーションからインフラ実装へ直接依存しないようパス制約を導入し、違反時にビルドを止める
  - _Requirements: 6.1,6.2,6.3,6.4_

- [x] 6.2 (P) 開発フローでのガードを導入する
  - ポート未経由の依存や循環参照を検出するリンター/型設定を追加し、CIでも実行する
  - パスエイリアスの解決と型チェックを強化し、設定漏れや誤参照を早期に検知する
  - _Requirements: 6.5,6.6,6.7_

- [x] 7. 段階的移行で既存機能を保護する
- [x] 7.1 (P) パイロット移行を計画し実施する
  - 小規模な機能をパイロットとして新アーキテクチャに載せ、旧構成との共存ポリシーとロールバック手順を明確にする
  - パイロット完了時に関係者へ共有し、挙動変更があれば承認を取る
  - _Requirements: 7.9,9.1,9.2,9.3_

- [x] 7.2 全機能を新レイヤーへ移行しクリーンアップする
  - イベント、タイムテーブル、管理、プロフィール各機能を順次新レイヤーに移し、Spindle UIを維持したまま動作確認する
  - 旧インポートパスを新しいエイリアスへ更新し、移行済みコードの重複や未使用部分を除去する
  - 移行完了後に旧構成への依存を断ち、クリーンな状態を保証する
  - _Requirements: 1.6,5.1,5.2,5.4,5.6,7.1,7.2,7.3,7.4,7.5,7.6,9.5,9.8_

- [x] 7.3 リグレッションとロールバックの検証を行う
  - 主要ユーザーフロー（プロフィール、イベント登録、タイムテーブル、管理操作）がリファクタ前と同じ結果を返すことを確認する
  - すべてのページがアクセス可能であることと、性能劣化がないことを検証する
  - 段階ごとに戻せるブランチやタグを用意し、問題発生時に安全に戻せることを確認する
  - _Requirements: 7.7,7.8,9.4,9.6,9.7_

- [x] 8. テスト体系を整備し品質を担保する
- [x] 8.1 (P) テスト基盤とカバレッジ計測を準備する
  - Next.js 15と互換性のあるテストランナーとカバレッジツールを導入し、各レイヤーのテスト配置方針を決める
  - テストコマンドをCIに組み込み、閾値設定で品質ゲートを用意する
  - _Requirements: 8.4,8.6,8.7_

- [x] 8.2 (P) ドメインのユニットテストを追加する
  - 学年計算やステータス有効性などのビジネスロジックを外部依存なしで検証する
  - 値オブジェクトのバリデーションが期待通りに失敗するケースも網羅する
  - _Requirements: 8.1,8.8_

- [x] 8.3 (P) アプリケーションユースケースのテストを実装する
  - モックリポジトリを注入してユースケースの正常系・異常系を検証し、エラー分類が正しく返ることを確認する
  - DTO変換のシリアライズ性をチェックし、境界でのデータ欠損を防ぐ
  - _Requirements: 8.2,8.5,8.8_

- [x] 8.4 (P) インフラ統合テストを実施する
  - リポジトリ実装がデータソースと正しくやり取りできることを確認し、マッピングのずれを検出する
  - トランザクション系のRPCが期待通りにコミット/ロールバックされることを検証する
  - _Requirements: 8.3_

- [x] 8.5 (P) 重要フローのE2Eを整備する
  - プロフィール表示、イベント登録、管理操作、タイムテーブル表示などのクリティカルパスをE2Eでカバーする
  - UI上のエラー表示やフィルタリング結果が期待通りであることを確認し、リグレッションの早期検知を図る
  - _Requirements: 7.7,7.8_

- [x] 9. 開発者体験とナレッジを整備する
- [x] 9.1 (P) アーキテクチャガイドを整備する
  - レイヤー責務と依存性ルールを説明するガイドを用意し、新しいユースケース追加時の手順と例を示す
  - リポジトリ追加方法とディレクトリ配置規則をまとめ、各レイヤーに短いREADMEを配置する
  - _Requirements: 10.1,10.2,10.3,10.4_

- [x] 9.2 (P) 開発者オンボーディングを準備する
  - 新規参加者がセットアップから主要フロー実行まで辿れるオンボーディング資料を整える
  - 振る舞い変更が必要な場合の承認・通知プロセスを含め、運用上のガイドラインをまとめる
  - _Requirements: 10.5,10.7_

- [x] 9.3 (P) コード生成テンプレートとスクリプトを用意する
  - 新しいエンティティ・ユースケース・リポジトリを作成するためのテンプレートやスクリプトを提供し、開発手順を標準化する
  - Steering Contextを最新のアーキテクチャパターンに合わせて更新する
  - _Requirements: 10.6,10.7_
